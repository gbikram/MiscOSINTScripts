import requests
from bs4 import BeautifulSoup
import iocextract

index_page = requests.get("https://pastebin.com/u/malware_traffic")
soup = BeautifulSoup(index_page.content, 'html.parser')
pastes_table = soup.find('table')
paste_paths = pastes_table.find_all('a', href=True)
latest_paste_text = paste_paths[0].get_text()
latest_paste_path = paste_paths[0]['href']

print()
print("Most recent paste: " + latest_paste_text)
print()

paste = requests.get("https://pastebin.com/raw" + latest_paste_path)

with open('paste.txt', 'wb') as file:
    file.write(paste.content)

print("Raw paste saved!")
print()

paste_file = open('paste.txt', 'r')
lines = paste_file.read()
paste_file.close()

urls_file = open('urls.txt', 'w')
hashes_file = open('hashes.txt', 'w')
ips_file = open('ips.txt', 'w')

for url in iocextract.extract_urls(lines, refang=True):
    urls_file.write(url + "\n")

print("URLs extracted!")
print()

for mal_hash in iocextract.extract_hashes(lines):
    hashes_file.write(mal_hash + "\n")

print("Hashes extracted!")
print()

for ip in iocextract.extract_ips(lines, refang=True):
    ips_file.write(ip + "\n")

print("IPs extracted!")
print()
